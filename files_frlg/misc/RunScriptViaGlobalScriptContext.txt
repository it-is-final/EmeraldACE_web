@@ title = "Run script via GlobalScriptContext"
@@ author = "final and Mettrich"
@@ exit = "ROM_BX_lr_Box10_Grab"
@@ filler4 = 0xffffffff

// This code inserts a custom script pointer into the global script
// context (and also sets some other stuff) that will run as soon as
// you leave Bill’s PC in a Pokémon Center or in the Daycare.
//
// Script addresses from "Run script via NPC" should work here.
//
// Trigger ACE, then leave the boxes, and then exit the menu, the
// script should run.

script_address = 0

@@

MOV     r10, #0x3000000             ; Prepare sGlobalScriptContextStatus address part 1

MOV     r12, r14, ASR #19           ; r12 = 0x1??, prepare mode, and stackDepth part 1
BIC     r12, r12, #0xff             ; r12 = 0x100, prepare mode, and stackDepth part 2

STRB    r12, [r10, #0xea8]!         ; Store RUNNING status in sGlobalScriptContextStatus, address part 2

STRH    r12, [r10, #8]              ; Store in sGlobalScriptContext->stackDepth, and sGlobalScriptContext->mode

MOV     r12, #{script_address} ?
STR     r12, [r10, r14, ASR #23]!   ; Store in sGlobalScriptContext->scriptPtr